<!DOCTYPE html>
<!-- HTML Versie: 2.1 -->
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Importer & Cleaner Wizard</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; display: grid; place-content: center; min-height: 100vh; background-color: #f0f2f5; margin: 0; padding: 1rem; }
        .wizard { background: white; border-radius: 8px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 100%; max-width: 600px; }
        .step { padding: 2rem 2.5rem; border-bottom: 1px solid #e9ecef; }
        .step:last-child { border-bottom: none; }
        .step.is-disabled { opacity: 0.4; pointer-events: none; }
        h2 { font-size: 1.5rem; margin-top: 0; color: #333; }
        p, li { color: #555; line-height: 1.6; }
        a { color: #007bff; text-decoration: none; }
        a:hover { text-decoration: underline; }
        textarea { width: 100%; min-height: 120px; font-family: monospace; font-size: 0.9rem; padding: 0.5rem; border: 1px solid #ced4da; border-radius: 4px; box-sizing: border-box; margin-top: 0.5rem; }
        button { font-size: 1rem; padding: 0.75rem 1.5rem; cursor: pointer; background-color: #007bff; color: white; border: none; border-radius: 5px; transition: background-color 0.2s; }
        button:disabled { background-color: #6c757d; cursor: not-allowed; }
        .cleanup-btn { background-color: #dc3545; }
        .status-check { display: flex; align-items: center; gap: 0.75rem; margin-top: 1rem; }
        .status-light { width: 12px; height: 12px; border-radius: 50%; background-color: #6c757d; transition: background-color 0.3s; }
        .status-light.is-ok { background-color: #28a745; }
        .status-light.is-bad { background-color: #dc3545; }
        .status-text { font-weight: 500; }
        .status-text.is-ok { color: #28a745; }
        .status-text.is-bad { color: #dc3545; }
        .info { font-size: 0.9rem; color: #6c757d; }
        #data-selector-container { margin-top: 1rem; }
        #data-selector { font-size: 1rem; padding: 0.5rem; }
    </style>
</head>
<body>
    <div class="wizard">
        <!-- Stap 1: Security Rules Openen -->
        <div class="step" id="step-1">
            <h2>Stap 1: Zet de Database Open</h2>
            <p>Kopieer de onderstaande regels en plak ze in je <a href="https://console.firebase.google.com/project/voetbaltrainers/firestore/rules" target="_blank">Firebase Security Rules</a>. Druk daarna op 'Publiceren'.</p>
            <textarea readonly>rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /{document=**} {
      allow read, write: if true;
    }
  }
}</textarea>
            <div class="status-check">
                <button id="check-open-btn">Controleer Permissies</button>
                <div id="open-status-light" class="status-light"></div>
                <span id="open-status-text" class="status-text">Wacht op controle...</span>
            </div>
        </div>

        <!-- Stap 1.5: Data Opschonen (Nieuw) -->
        <div class="step is-disabled" id="step-cleanup">
            <h2>Stap 2: Verwijder Verouderde Clubdata</h2>
            <p>Gebruik deze knop om de seizoendata van de oude clubs ('Sportclub Enschede' en 'AZ \'54') eenmalig uit de database te verwijderen.</p>
            <div class="status-check">
                <button id="cleanup-btn" class="cleanup-btn">Start Opschonen</button>
                <span id="cleanup-status-text" class="status-text">Wacht op actie...</span>
            </div>
        </div>

        <!-- Stap 2 -> 3: Data Importeren -->
        <div class="step is-disabled" id="step-import">
            <h2>Stap 3: Selecteer en Importeer Data</h2>
            <p>Kies het databestand uit je GitHub repository dat je wilt importeren. Dit is optioneel na het opschonen.</p>
            <div id="data-selector-container">Laden van bestanden...</div>
            <div class="status-check">
                <button id="import-btn" disabled>Start Import</button>
                <span id="import-status-text" class="status-text">Selecteer eerst een bestand.</span>
            </div>
        </div>

        <!-- Stap 3 -> 4: Security Rules Sluiten -->
        <div class="step is-disabled" id="step-close">
            <h2>Stap 4: Zet de Database Dicht</h2>
            <p><strong>BELANGRIJK:</strong> Kopieer nu de onderstaande regels en plak ze terug in je Firebase Security Rules om je database te beveiligen.</p>
            <textarea readonly>rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /{document=**} {
      allow read: if true;
      allow write: if false;
    }
  }
}</textarea>
            <div class="status-check">
                <button id="check-closed-btn">Controleer Beveiliging</button>
                <div id="closed-status-light" class="status-light"></div>
                <span id="closed-status-text" class="status-text">Wacht op controle...</span>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, writeBatch, doc, setDoc, deleteDoc, query, where } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        
        const firebaseConfig = {
          apiKey: "AIzaSyDZckphHLQiTK2KZHPOyPDxgB6glBr4HpY",
          authDomain: "voetbaltrainers.firebaseapp.com",
          projectId: "voetbaltrainers",
          storageBucket: "voetbaltrainers.appspot.com",
          messagingSenderId: "640532231483",
          appId: "1:640532231483:web:54d614b65b3e2c4adc731e",
          measurementId: "G-YQV6E3V2CK"
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // UI Elementen
        const steps = {
            cleanup: document.getElementById('step-cleanup'),
            import: document.getElementById('step-import'),
            close: document.getElementById('step-close')
        };
        const buttons = {
            checkOpen: document.getElementById('check-open-btn'),
            cleanup: document.getElementById('cleanup-btn'),
            import: document.getElementById('import-btn'),
            checkClosed: document.getElementById('check-closed-btn')
        };
        const statuses = {
            openText: document.getElementById('open-status-text'),
            openLight: document.getElementById('open-status-light'),
            cleanupText: document.getElementById('cleanup-status-text'),
            importText: document.getElementById('import-status-text'),
            closedText: document.getElementById('closed-status-text'),
            closedLight: document.getElementById('closed-status-light')
        };
        const dataSelectorContainer = document.getElementById('data-selector-container');

        buttons.checkOpen.addEventListener('click', async () => {
            statuses.openText.textContent = 'Bezig met testen...';
            const testDocRef = doc(db, 'permissions-test', 'test-doc');
            try {
                await setDoc(testDocRef, { timestamp: new Date() });
                await deleteDoc(testDocRef);
                statuses.openLight.className = 'status-light is-ok';
                statuses.openText.className = 'status-text is-ok';
                statuses.openText.textContent = 'Permissies correct ingesteld!';
                steps.cleanup.classList.remove('is-disabled');
                steps.import.classList.remove('is-disabled');
                steps.close.classList.remove('is-disabled');
                loadDataFiles();
            } catch (e) {
                statuses.openLight.className = 'status-light is-bad';
                statuses.openText.className = 'status-text is-bad';
                statuses.openText.textContent = 'Fout: Geen schrijfrechten. Controleer de regels.';
            }
        });

        buttons.cleanup.addEventListener('click', async () => {
            if (!confirm("Weet je zeker dat je alle seizoendata voor 'Sportclub Enschede' en 'AZ \\'54' permanent wilt verwijderen?")) {
                statuses.cleanupText.textContent = 'Opschonen geannuleerd.';
                return;
            }

            const clubsToDelete = ["Sportclub Enschede", "AZ '54"];
            statuses.cleanupText.textContent = `Zoeken naar data voor: ${clubsToDelete.join(', ')}...`;

            try {
                const seizoenenCol = collection(db, "seizoenen");
                const q = query(seizoenenCol, where("club", "in", clubsToDelete));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    statuses.cleanupText.className = 'status-text';
                    statuses.cleanupText.textContent = 'Geen data gevonden om op te schonen.';
                    return;
                }

                statuses.cleanupText.textContent = `${querySnapshot.size} document(en) gevonden. Bezig met verwijderen...`;
                const batch = writeBatch(db);
                querySnapshot.forEach(doc => {
                    batch.delete(doc.ref);
                });

                await batch.commit();

                statuses.cleanupText.className = 'status-text is-ok';
                statuses.cleanupText.textContent = `${querySnapshot.size} document(en) succesvol verwijderd.`;
                
            } catch (error) {
                statuses.cleanupText.className = 'status-text is-bad';
                statuses.cleanupText.textContent = `Fout bij opschonen: ${error.message}`;
            }
        });
        
        async function loadDataFiles() {
            try {
                const response = await fetch('https://api.github.com/repos/jasperkoningnl/voetbaltrainers/contents/data');
                const files = await response.json();
                const jsonFiles = files.filter(file => file.name.endsWith('.json'));

                if (jsonFiles.length > 0) {
                    let selectHTML = '<select id="data-selector"><option value="">-- Kies een bestand --</option>';
                    jsonFiles.forEach(file => {
                        selectHTML += `<option value="${file.download_url}">${file.name}</option>`;
                    });
                    selectHTML += '</select>';
                    dataSelectorContainer.innerHTML = selectHTML;
                    document.getElementById('data-selector').addEventListener('change', () => {
                        buttons.import.disabled = false;
                        statuses.importText.textContent = 'Klaar om te importeren.';
                    });
                } else {
                    dataSelectorContainer.innerHTML = '<p class="error">Geen .json bestanden gevonden in de /data map.</p>';
                }
            } catch (e) {
                dataSelectorContainer.innerHTML = '<p class="error">Kon bestanden niet laden van GitHub.</p>';
            }
        }

        buttons.import.addEventListener('click', async () => {
            const selector = document.getElementById('data-selector');
            const fileUrl = selector.value;
            if (!fileUrl) return;

            buttons.import.disabled = true;
            statuses.importText.textContent = `Downloaden van ${selector.options[selector.selectedIndex].text}...`;

            try {
                const response = await fetch(fileUrl);
                const dataToImport = await response.json();
                statuses.importText.textContent = 'Download compleet. Starten met import...';
                
                const coachesCol = collection(db, "coaches");
                const seizoenenCol = collection(db, "seizoenen");
                const existingCoachesSnapshot = await getDocs(coachesCol);
                const existingCoaches = new Map();
                existingCoachesSnapshot.forEach(doc => {
                    const data = doc.data();
                    if(data.naam) existingCoaches.set(data.naam.toLowerCase(), doc.id);
                });

                const newCoaches = dataToImport.coaches.filter(c => c.naam && !existingCoaches.has(c.naam.toLowerCase()));
                if(newCoaches.length > 0) {
                    const batchCoaches = writeBatch(db);
                    for (const coach of newCoaches) {
                        const newCoachRef = doc(coachesCol);
                        batchCoaches.set(newCoachRef, coach);
                        existingCoaches.set(coach.naam.toLowerCase(), newCoachRef.id); 
                    }
                    await batchCoaches.commit();
                }

                const batchSeizoenen = writeBatch(db);
                let seizoenCount = 0;
                for (const seizoen of dataToImport.seizoenen) {
                    if (!seizoen.coachNaam) continue;
                    const coachId = existingCoaches.get(seizoen.coachNaam.toLowerCase());
                    if (coachId) {
                        const seizoenData = { ...seizoen, coachId: coachId };
                        delete seizoenData.coachNaam; 
                        
                        const newSeizoenRef = doc(seizoenenCol);
                        batchSeizoenen.set(newSeizoenRef, seizoenData);
                        seizoenCount++;
                    }
                }
                await batchSeizoenen.commit();

                statuses.importText.className = 'status-text is-ok';
                statuses.importText.textContent = `Import voltooid! ${newCoaches.length} nieuwe coaches en ${seizoenCount} seizoenen verwerkt.`;

            } catch (error) {
                statuses.importText.className = 'status-text is-bad';
                statuses.importText.textContent = `Fout: ${error.message}`;
                buttons.import.disabled = false;
            }
        });
        
        buttons.checkClosed.addEventListener('click', async () => {
             statuses.closedText.textContent = 'Bezig met testen...';
            const testDocRef = doc(db, 'permissions-test', 'test-doc-final');
            try {
                await setDoc(testDocRef, { timestamp: new Date() });
                statuses.closedLight.className = 'status-light is-bad';
                statuses.closedText.className = 'status-text is-bad';
                statuses.closedText.textContent = 'Fout: Database staat nog open! Controleer de regels.';
                await deleteDoc(testDocRef);
            } catch (e) {
                statuses.closedLight.className = 'status-light is-ok';
                statuses.closedText.className = 'status-text is-ok';
                statuses.closedText.textContent = 'Database succesvol beveiligd!';
            }
        });

    </script>
</body>
</html>
