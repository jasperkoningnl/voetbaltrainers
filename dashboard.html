<!DOCTYPE html>
<!-- Dashboard Versie: 6.4 - Stabiliteitsverbetering & Cache-Busting -->
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voetbaltrainers Data Dashboard</title>
    
    <!-- Tailwind CSS voor styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & Babel voor de applicatielogica -->
    <script src="https://unpkg.com/react@17/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Firebase SDK's -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { getFirestore, collection, getDocs, doc, writeBatch, updateDoc, query, where, addDoc, setDoc } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDZckphHLQiTK2KZHPOyPDxgB6glBr4HpY",
            authDomain: "voetbaltrainers.firebaseapp.com",
            projectId: "voetbaltrainers",
            storageBucket: "voetbaltrainers.appspot.com",
            messagingSenderId: "640532231483",
            appId: "1:640532231483:web:54d614b65b3e2c4adc731e",
            measurementId: "G-YQV6E3V2CK"
        };
        
        const app = initializeApp(firebaseConfig);
        window.firebaseServices = {
            auth: getAuth(app),
            db: getFirestore(app),
            GoogleAuthProvider,
            signInWithPopup,
            signOut,
            onAuthStateChanged,
            collection,
            getDocs,
            doc,
            writeBatch,
            updateDoc,
            query, 
            where,
            addDoc,
            setDoc
        };
    </script>
</head>
<body class="bg-gray-100 text-gray-800">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useMemo } = React;
        const { db, auth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged, collection, getDocs, doc, writeBatch, updateDoc, query, where, addDoc, setDoc } = window.firebaseServices;

        // --- Iconen ---
        const DatabaseIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="h-5 w-5"><ellipse cx="12" cy="5" rx="9" ry="3"></ellipse><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"></path><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"></path></svg>;
        const UserIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="h-5 w-5"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>;
        const SparklesIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="h-5 w-5"><path d="m12 3-1.9 5.8-5.8 1.9 5.8 1.9 1.9 5.8 1.9-5.8 5.8-1.9-5.8-1.9Z"></path></svg>;
        const LogOutIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="h-5 w-5"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" x2="9" y1="12" y2="12"></line></svg>;
        const EditIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="h-4 w-4"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"></path><path d="m15 5 4 4"></path></svg>;
        const SaveIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="h-4 w-4"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>;
        const CancelIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="h-4 w-4"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>;
        const DownloadIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="h-5 w-5 mr-2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>;
        const UploadIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="h-5 w-5 mr-2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>;
        const ListIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="h-5 w-5"><line x1="8" x2="21" y1="6" y2="6"></line><line x1="8" x2="21" y1="12" y2="12"></line><line x1="8" x2="21" y1="18" y2="18"></line><line x1="3" x2="3.01" y1="6" y2="6"></line><line x1="3" x2="3.01" y1="12" y2="12"></line><line x1="3" x2="3.01" y1="18" y2="18"></line></svg>;

        function App() {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [view, setView] = useState('ai'); 

            useEffect(() => {
                const unsubscribe = onAuthStateChanged(auth, (currentUser) => {
                    setUser(currentUser);
                    setLoading(false);
                });
                return () => unsubscribe();
            }, []);

            const handleLogin = () => {
                const provider = new GoogleAuthProvider();
                signInWithPopup(auth, provider).catch(error => console.error("Login Fout:", error));
            };

            const handleLogout = () => {
                signOut(auth).catch(error => console.error("Logout Fout:", error));
            };

            if (loading) { return <div className="flex items-center justify-center h-screen"><p>Dashboard laden...</p></div> }
            if (!user) {
                return (
                    <div className="flex items-center justify-center h-screen bg-gray-200">
                        <div className="text-center bg-white p-10 rounded-lg shadow-xl">
                            <h1 className="text-3xl font-bold mb-2">Data Dashboard</h1>
                            <p className="text-gray-600 mb-6">Log in om de data te beheren.</p>
                            <button onClick={handleLogin} className="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded inline-flex items-center">
                                <svg className="w-6 h-6 mr-2" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"></path><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"></path><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"></path><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"></path><path fill="none" d="M0 0h48v48H0z"></path></svg>
                                <span>Login met Google</span>
                            </button>
                        </div>
                    </div>
                );
            }
             return (
                <div className="flex h-screen">
                    <aside className="w-64 bg-gray-800 text-white flex flex-col">
                        <div className="p-4 border-b border-gray-700">
                            <h2 className="text-xl font-bold">Dashboard</h2>
                            <span className="text-sm text-gray-400">v6.4</span>
                        </div>
                        <nav className="flex-grow p-2">
                             <a href="#" onClick={() => setView('clubs')} className={`flex items-center gap-3 px-3 py-2 rounded-md ${view === 'clubs' ? 'bg-gray-700' : 'hover:bg-gray-700'}`}>
                                <DatabaseIcon /> Clubs Beheren
                            </a>
                            <a href="#" onClick={() => setView('coaches')} className={`flex items-center gap-3 px-3 py-2 mt-1 rounded-md ${view === 'coaches' ? 'bg-gray-700' : 'hover:bg-gray-700'}`}>
                                <UserIcon /> Coaches Beheren
                            </a>
                             <a href="#" onClick={() => setView('seasons')} className={`flex items-center gap-3 px-3 py-2 mt-1 rounded-md ${view === 'seasons' ? 'bg-gray-700' : 'hover:bg-gray-700'}`}>
                                <ListIcon /> Seizoenen Beheren
                            </a>
                            <a href="#" onClick={() => setView('ai')} className={`flex items-center gap-3 px-3 py-2 mt-1 rounded-md ${view === 'ai' ? 'bg-gray-700' : 'hover:bg-gray-700'}`}>
                                <SparklesIcon /> AI Assistent
                            </a>
                        </nav>
                        <div className="p-4 border-t border-gray-700">
                            <div className="flex items-center gap-2 mb-4">
                                <img src={user.photoURL} alt={user.displayName} className="w-8 h-8 rounded-full" />
                                <span className="text-sm font-medium">{user.displayName}</span>
                            </div>
                            <button onClick={handleLogout} className="w-full flex items-center justify-center gap-3 px-3 py-2 rounded-md bg-red-600 hover:bg-red-700">
                               <LogOutIcon /> Uitloggen
                            </button>
                        </div>
                    </aside>
                    <main className="flex-1 p-8 overflow-y-auto" key={view}>
                        {
                            {
                                'clubs': <ClubsView />,
                                'coaches': <CoachesView />,
                                'seasons': <SeasonsView />,
                                'ai': <AiView />
                            }[view]
                        }
                    </main>
                </div>
            );
        }
        
        function ClubsView() {
            const [clubs, setClubs] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [editingClubId, setEditingClubId] = useState(null);
            const [logoUrlInput, setLogoUrlInput] = useState("");

            const fetchClubs = useCallback(async () => {
                setLoading(true);
                setError(null);
                try {
                    const querySnapshot = await getDocs(collection(db, "clubs"));
                    const clubsData = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    clubsData.sort((a, b) => a.naam.localeCompare(b.naam));
                    setClubs(clubsData);
                } catch (e) { console.error("Fout bij ophalen clubs:", e); setError("Kon de clubs niet laden."); }
                setLoading(false);
            }, []);

            useEffect(() => { fetchClubs(); }, [fetchClubs]);
            
            const handleInitializeClubs = async () => {
                setLoading(true);
                setError("Bezig met initialiseren...");
                try {
                    const seizoenenSnapshot = await getDocs(collection(db, "seizoenen"));
                    const uniqueClubs = new Map();
                    seizoenenSnapshot.docs.forEach(doc => {
                        const data = doc.data();
                        if (data.club && data.land) {
                            uniqueClubs.set(data.club, { naam: data.club, land: data.land, logo_url: data.logo_url || "" });
                        }
                    });
                    const batch = writeBatch(db);
                    uniqueClubs.forEach((clubData, clubName) => {
                        const clubRef = doc(db, "clubs", clubName);
                        batch.set(clubRef, clubData);
                    });
                    await batch.commit();
                    setError(null);
                    fetchClubs();
                } catch(e) { console.error("Fout bij initialiseren:", e); setError("Initialisatie mislukt."); }
                setLoading(false);
            };

            const handleEdit = (club) => { setEditingClubId(club.id); setLogoUrlInput(club.logo_url); };
            const handleSave = async (clubId) => {
                const clubRef = doc(db, "clubs", clubId);
                try {
                    await updateDoc(clubRef, { logo_url: logoUrlInput });
                    setEditingClubId(null);
                    setClubs(clubs.map(c => c.id === clubId ? {...c, logo_url: logoUrlInput} : c));
                } catch (e) { console.error("Update Fout:", e); alert("Opslaan mislukt."); }
            };
            
            if (loading && clubs.length === 0) return <div>Laden...</div>;
            if (clubs.length === 0 && !loading) {
                 return (
                    <div>
                        <h1 className="text-3xl font-bold mb-6">Club Beheer</h1>
                        <div className="bg-white p-6 rounded-lg shadow-md text-center">
                            <h2 className="text-xl font-semibold mb-2">Database is leeg</h2>
                            <p className="text-gray-600 mb-4">De 'clubs' collectie bestaat nog niet. Initialiseer deze.</p>
                            <button onClick={handleInitializeClubs} className="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">Initialiseer Club Database</button>
                            {error && <p className="text-red-500 mt-4">{error}</p>}
                        </div>
                    </div>
                );
            }

            return (
                 <div>
                    <h1 className="text-3xl font-bold mb-6">Club Beheer</h1>
                    <div className="bg-white p-6 rounded-lg shadow-md overflow-x-auto">
                        <table className="w-full text-left">
                           <thead><tr className="border-b"><th className="p-2 w-28">Acties</th><th className="p-2">Club</th><th className="p-2">Land</th><th className="p-2">Logo URL</th></tr></thead>
                           <tbody>
                             {clubs.map(club => (
                               <tr key={club.id} className="border-b last:border-b-0 hover:bg-gray-50 align-top">
                                  <td className="p-2">
                                     {editingClubId === club.id ? (<button onClick={() => handleSave(club.id)} className="p-1.5 bg-green-500 text-white rounded-md hover:bg-green-600"><SaveIcon /></button>) : (<button onClick={() => handleEdit(club)} className="p-1.5 bg-blue-500 text-white rounded-md hover:bg-blue-600"><EditIcon /></button>)}
                                  </td>
                                  <td className="p-2 font-medium">{club.naam}</td><td className="p-2">{club.land}</td>
                                  <td className="p-2">
                                    {editingClubId === club.id ? (<input type="text" value={logoUrlInput} onChange={(e) => setLogoUrlInput(e.target.value)} className="w-full p-1 border rounded-md" />) : (
                                        <div className="flex items-center gap-4"><img src={club.logo_url} className="h-8 w-8 object-contain bg-gray-100 p-1 rounded-sm flex-shrink-0" alt={`Logo ${club.naam}`} onError={(e) => {e.target.onerror = null; e.target.src='https://placehold.co/32x32/e2e8f0/a0aec0?text=?'}} />
                                          <span className="text-xs text-gray-500 break-all" title={club.logo_url}>{club.logo_url}</span>
                                        </div>
                                    )}
                                  </td>
                               </tr>
                             ))}
                           </tbody>
                        </table>
                    </div>
                </div>
            );
        }

        function CoachesView() {
            const [coaches, setCoaches] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [searchTerm, setSearchTerm] = useState("");
            const [editingCoachId, setEditingCoachId] = useState(null);
            const [editFormData, setEditFormData] = useState({});
            const [file, setFile] = useState(null);
            const [uploadStatus, setUploadStatus] = useState('');
            const [isCheckingImages, setIsCheckingImages] = useState(false);

            const fetchCoaches = useCallback(async () => {
                setLoading(true);
                setError(null);
                try {
                    const querySnapshot = await getDocs(collection(db, "coaches"));
                    const coachesData = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    coachesData.sort((a, b) => a.naam.localeCompare(b.naam));
                    setCoaches(coachesData);
                } catch (e) { console.error("Fout bij ophalen coaches:", e); setError("Kon de coaches niet laden."); }
                setLoading(false);
            }, []);

            useEffect(() => { fetchCoaches(); }, [fetchCoaches]);

            const handleEdit = (coach) => { setEditingCoachId(coach.id); setEditFormData({ ...coach }); };
            const handleCancel = () => { setEditingCoachId(null); };
            const handleInputChange = (e) => { const { name, value } = e.target; setEditFormData(prev => ({ ...prev, [name]: value })); };

            const handleSave = async (coachId) => {
                const coachRef = doc(db, "coaches", coachId);
                try {
                    // Expliciet een nieuw object maken om problemen te voorkomen
                    const dataToSave = {
                        naam: editFormData.naam,
                        nationaliteit: editFormData.nationaliteit,
                        nat_code: editFormData.nat_code,
                        foto_url: editFormData.foto_url
                    };
                    await updateDoc(coachRef, dataToSave);
                    setEditingCoachId(null);
                    setCoaches(coaches.map(c => c.id === coachId ? { ...c, ...dataToSave } : c));
                } catch(e) { console.error("Update Fout:", e); alert("Opslaan van coach mislukt."); }
            };
            
            const checkImage = (url) => {
                return new Promise((resolve) => {
                    if (!url || typeof url !== 'string' || url.trim() === '') {
                        resolve({url, status: 'error'}); return;
                    }
                    const img = new Image();
                    img.onload = () => resolve({url, status: 'ok'});
                    img.onerror = () => resolve({url, status: 'error'});
                    img.src = url;
                });
            }

            const handleDownloadProblematicPhotos = async () => {
                setIsCheckingImages(true);
                setUploadStatus("Bezig met controleren van alle afbeeldingen...");
                const checkPromises = coaches.map(c => checkImage(c.foto_url));
                const results = await Promise.all(checkPromises);
                const brokenUrls = new Set(results.filter(r => r.status === 'error').map(r => r.url));
                const coachesToUpdate = coaches.filter(c => !c.foto_url || brokenUrls.has(c.foto_url));
                setIsCheckingImages(false);

                if (coachesToUpdate.length === 0) {
                    setUploadStatus("Klaar! Geen coaches met lege of niet-werkende foto-URL's gevonden.");
                    return;
                }
                
                setUploadStatus(`${coachesToUpdate.length} problematische records gevonden. CSV wordt voorbereid...`);
                let csvContent = "id,naam,foto_url\n";
                coachesToUpdate.forEach(coach => {
                    csvContent += `${coach.id},"${coach.naam}","${coach.foto_url || ''}"\n`;
                });
                
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", "coaches_met_problemen.csv");
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                setUploadStatus(`CSV 'coaches_met_problemen.csv' gedownload.`);
            };

            const handleFileUpload = (event) => { setFile(event.target.files[0]); setUploadStatus(''); };
            const handleProcessUpload = () => {
                if (!file) { setUploadStatus('Selecteer eerst een bestand.'); return; }
                const reader = new FileReader();
                reader.onload = async (e) => {
                    setUploadStatus('Bestand verwerken...');
                    const text = e.target.result;
                    const lines = text.split('\n').slice(1);
                    const batch = writeBatch(db);
                    let updatesCount = 0;
                    for(const line of lines) {
                        if (line.trim() === '') continue;
                        const [id, name, foto_url] = line.split(',');
                        const trimmedUrl = foto_url ? foto_url.trim().replace(/"/g, '') : '';
                        if (id && trimmedUrl) {
                            const coachRef = doc(db, "coaches", id);
                            batch.update(coachRef, { foto_url: trimmedUrl });
                            updatesCount++;
                        }
                    }
                    if (updatesCount > 0) {
                        try {
                            await batch.commit();
                            setUploadStatus(`${updatesCount} coach-foto's succesvol bijgewerkt! De lijst wordt herladen.`);
                            fetchCoaches();
                        } catch (error) { setUploadStatus(`Fout bij het uploaden: ${error.message}`); }
                    } else { setUploadStatus('Geen geldige updates gevonden in het bestand.'); }
                };
                reader.readAsText(file);
            };

            const filteredCoaches = useMemo(() => 
                coaches.filter(coach => 
                    coach.naam.toLowerCase().includes(searchTerm.toLowerCase())
                ), [coaches, searchTerm]);

            if (loading) return <div>Coaches laden...</div>;
            if (error) return <div className="text-red-500">{error}</div>;

            return (
                 <div>
                    <h1 className="text-3xl font-bold mb-6">Coach Beheer</h1>
                    <div className="bg-white p-6 rounded-lg shadow-md mb-6">
                        <h2 className="text-xl font-semibold mb-4 border-b pb-2">Bulk Operaties</h2>
                        <div className="flex flex-wrap items-start gap-6">
                            <div className="flex-1 min-w-[250px]">
                                <h3 className="font-semibold">Stap 1: Download Lijst</h3>
                                <p className="text-sm text-gray-500 mb-2">Download een CSV van coaches met een lege of kapotte foto-URL.</p>
                                <button onClick={handleDownloadProblematicPhotos} disabled={isCheckingImages} className="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded inline-flex items-center disabled:bg-gray-400">
                                    <DownloadIcon /> {isCheckingImages ? 'Bezig met controleren...' : 'Download Probleemlijst'}
                                </button>
                            </div>
                            <div className="flex-1 min-w-[250px]">
                                <h3 className="font-semibold">Stap 2: Upload Lijst</h3>
                                <p className="text-sm text-gray-500 mb-2">Vul de 'foto_url' kolom aan en upload het bestand om de data in bulk bij te werken.</p>
                                <input type="file" accept=".csv" onChange={handleFileUpload} className="text-sm"/>
                                <button onClick={handleProcessUpload} disabled={!file} className="mt-2 bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded inline-flex items-center disabled:bg-gray-400">
                                    <UploadIcon /> Verwerk Bestand
                                </button>
                            </div>
                        </div>
                        {uploadStatus && <p className="text-sm text-gray-700 mt-4 bg-gray-100 p-2 rounded-md">{uploadStatus}</p>}
                    </div>
                    <div className="bg-white p-6 rounded-lg shadow-md">
                        <input type="text" placeholder="Zoek coach op naam..." value={searchTerm} onChange={e => setSearchTerm(e.target.value)} className="w-full max-w-sm p-2 border rounded-md mb-4"/>
                        <div className="overflow-x-auto">
                           <table className="w-full text-left">
                               <thead>
                                 <tr className="border-b">
                                   <th className="p-2 w-28">Acties</th>
                                   <th className="p-2">Naam</th>
                                   <th className="p-2">Nationaliteit</th>
                                   <th className="p-2">Landcode</th>
                                   <th className="p-2">Foto URL</th>
                                 </tr>
                               </thead>
                               <tbody>
                                 {filteredCoaches.map(coach => (
                                   <tr key={coach.id} className="border-b last:border-b-0 hover:bg-gray-50 align-top">
                                     {editingCoachId === coach.id ? (
                                        <>
                                            <td className="p-2 flex gap-2">
                                                <button onClick={() => handleSave(coach.id)} className="p-1.5 bg-green-500 text-white rounded-md hover:bg-green-600"><SaveIcon /></button>
                                                <button onClick={handleCancel} className="p-1.5 bg-gray-500 text-white rounded-md hover:bg-gray-600"><CancelIcon /></button>
                                            </td>
                                            <td><input name="naam" value={editFormData.naam} onChange={handleInputChange} className="w-full p-1 border rounded-md" /></td>
                                            <td><input name="nationaliteit" value={editFormData.nationaliteit} onChange={handleInputChange} className="w-full p-1 border rounded-md" /></td>
                                            <td><input name="nat_code" value={editFormData.nat_code} onChange={handleInputChange} className="w-20 p-1 border rounded-md" /></td>
                                            <td><input name="foto_url" value={editFormData.foto_url} onChange={handleInputChange} className="w-full p-1 border rounded-md" /></td>
                                        </>
                                     ) : (
                                        <>
                                            <td className="p-2">
                                                <button onClick={() => handleEdit(coach)} className="p-1.5 bg-blue-500 text-white rounded-md hover:bg-blue-600"><EditIcon /></button>
                                            </td>
                                            <td className="p-2 font-medium">{coach.naam}</td>
                                            <td className="p-2">{coach.nationaliteit}</td>
                                            <td className="p-2">{coach.nat_code}</td>
                                            <td className="p-2">
                                                <div className="flex items-center gap-4">
                                                    <img src={coach.foto_url} className="h-8 w-8 object-cover bg-gray-100 p-1 rounded-full flex-shrink-0" alt="" onError={(e) => {e.target.onerror = null; e.target.src='https://placehold.co/32x32/e2e8f0/a0aec0?text=?'}} />
                                                    <span className="text-xs text-gray-500 break-all" title={coach.foto_url}>{coach.foto_url}</span>
                                                </div>
                                            </td>
                                        </>
                                     )}
                                   </tr>
                                 ))}
                               </tbody>
                           </table>
                        </div>
                    </div>
                </div>
            );
        }
        
        function SeasonsView() {
            return (
                 <div>
                    <h1 className="text-3xl font-bold mb-6">Seizoenen Beheren</h1>
                    <div className="bg-white p-6 rounded-lg shadow-md">
                        <p>Hier komt de functionaliteit om individuele seizoensrecords te bekijken, bewerken en verwijderen.</p>
                    </div>
                </div>
            );
        }

        function AiView() {
            const [query, setQuery] = useState("Wie was de coach van Feyenoord in het seizoen 1974/1975?");
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState(null);
            const [aiResponse, setAiResponse] = useState(null);

            const handleAskAI = async () => {
                setLoading(true);
                setError(null);
                setAiResponse(null);

                const apiKey = "AIzaSyByPVtZ-1sHdySwqbMzd63tdz5wxOzHw1Q";
                
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${apiKey}`;

                const prompt = `
                    Analyseer de volgende vraag over een voetbalcoach voor een specifieke club in een specifiek seizoen.
                    Vraag: "${query}"
                    Geef ALLEEN een JSON-object terug dat voldoet aan het volgende schema. Bedenk geen nieuwe velden.
                    Vul de waarden in op basis van de vraag.
                    - "seizoen": Het seizoen in "YYYY/YY" of "YYYY/YYYY" format.
                    - "club": De naam van de club.
                    - "coachNaam": De volledige naam van de hoofdcoach voor dat seizoen.
                    - "landstitel": "Y" als ze de nationale competitie wonnen, anders "N".
                    - "nationale_beker": "Y" als ze de belangrijkste nationale beker wonnen, anders "N".
                    - "europese_prijs": "Y" als ze een Europese prijs wonnen, anders "N".
                    - "land": Het land van de competitie (bv. "Netherlands" of "England").
                `;

                const payload = {
                    contents: [{ parts: [{ text: prompt }] }]
                };

                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorBody = await response.text();
                        console.error("API Error Body:", errorBody);
                        throw new Error(`API verzoek mislukt met status: ${response.status}. Controleer de API-sleutel en domein-instellingen in de Google Cloud Console.`);
                    }

                    const result = await response.json();
                    
                    if (result.candidates && result.candidates.length > 0) {
                        const rawText = result.candidates[0].content.parts[0].text;
                        const jsonMatch = rawText.match(/```json\n([\s\S]*)\n```/);
                        if (jsonMatch && jsonMatch[1]) {
                            const parsedJson = JSON.parse(jsonMatch[1]);
                            setAiResponse(parsedJson);
                        } else {
                           try {
                               const parsedJson = JSON.parse(rawText);
                               setAiResponse(parsedJson);
                           } catch (parseError) {
                               console.error("Raw text from AI:", rawText);
                               throw new Error("Kon geen geldig JSON-object vinden in het antwoord van de AI.");
                           }
                        }
                    } else {
                        console.warn("AI response candidates are empty", result);
                        throw new Error("Geen geldig antwoord ontvangen van de AI. Mogelijk is de content geblokkeerd.");
                    }

                } catch (e) {
                    console.error("Fout bij AI verzoek:", e);
                    setError(e.message);
                }
                setLoading(false);
            };

            const handleAddToDatabase = async () => {
                if (!aiResponse) return;
                setLoading(true);
                setError(null);

                try {
                    const coachesRef = collection(db, "coaches");
                    const q = query(coachesRef, where("naam", "==", aiResponse.coachNaam));
                    const coachSnapshot = await getDocs(q);

                    let coachId;
                    if (coachSnapshot.empty) {
                        const newCoachRef = await addDoc(coachesRef, {
                            naam: aiResponse.coachNaam,
                            nationaliteit: "",
                            nat_code: "",
                            foto_url: ""
                        });
                        coachId = newCoachRef.id;
                        alert(`Nieuwe coach "${aiResponse.coachNaam}" toegevoegd aan de database.`);
                    } else {
                        coachId = coachSnapshot.docs[0].id;
                    }

                    const seizoenenRef = collection(db, "seizoenen");
                    await addDoc(seizoenenRef, {
                        seizoen: aiResponse.seizoen,
                        club: aiResponse.club,
                        landstitel: aiResponse.landstitel,
                        nationale_beker: aiResponse.nationale_beker,
                        europese_prijs: aiResponse.europese_prijs,
                        land: aiResponse.land,
                        coachId: coachId
                    });

                    alert(`Seizoen ${aiResponse.seizoen} voor ${aiResponse.club} succesvol toegevoegd!`);
                    setAiResponse(null);
                } catch(e) {
                    console.error("Fout bij toevoegen aan database:", e);
                    setError("Kon data niet wegschrijven naar de database.");
                }

                setLoading(false);
            };

            return (
                <div>
                    <h1 className="text-3xl font-bold mb-6">AI Assistent</h1>
                    <div className="bg-white p-6 rounded-lg shadow-md">
                        <h2 className="text-xl font-semibold mb-2">Stel een vraag</h2>
                        <p className="text-sm text-gray-600 mb-4">Stel een specifieke vraag om een datagat op te vullen.</p>
                        <textarea value={query} onChange={(e) => setQuery(e.target.value)} className="w-full p-2 border rounded-md h-24"></textarea>
                        <button onClick={handleAskAI} disabled={loading} className="mt-2 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded inline-flex items-center disabled:bg-gray-400">
                            <SparklesIcon /> {loading ? "Bezig..." : "Vraag de AI"}
                        </button>
                        {error && <div className="mt-4 p-4 bg-red-100 text-red-700 rounded-md"><strong>Fout:</strong> {error}</div>}
                        {aiResponse && (
                            <div className="mt-6 border-t pt-6">
                                <h3 className="text-lg font-semibold mb-2">Voorgestelde Data:</h3>
                                <pre className="bg-gray-100 p-4 rounded-md overflow-x-auto">
                                    {JSON.stringify(aiResponse, null, 2)}
                                </pre>
                                <button onClick={handleAddToDatabase} disabled={loading} className="mt-4 bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded disabled:bg-gray-400">
                                    {loading ? "Bezig..." : "Voeg toe aan Database"}
                                </button>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));

    </script>
</body>
</html>
