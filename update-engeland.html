<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Engeland Data Updater</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; display: grid; place-content: center; min-height: 100vh; background-color: #f0f2f5; margin: 0; padding: 1rem; }
        .wizard { background: white; border-radius: 8px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 100%; max-width: 600px; }
        .step { padding: 2rem 2.5rem; border-bottom: 1px solid #e9ecef; }
        .step:last-child { border-bottom: none; }
        .step.is-disabled { opacity: 0.4; pointer-events: none; }
        h2 { font-size: 1.5rem; margin-top: 0; color: #333; }
        p, li { color: #555; line-height: 1.6; }
        a { color: #007bff; text-decoration: none; }
        a:hover { text-decoration: underline; }
        textarea { width: 100%; min-height: 120px; font-family: monospace; font-size: 0.9rem; padding: 0.5rem; border: 1px solid #ced4da; border-radius: 4px; box-sizing: border-box; margin-top: 0.5rem; }
        button { font-size: 1rem; padding: 0.75rem 1.5rem; cursor: pointer; background-color: #007bff; color: white; border: none; border-radius: 5px; transition: background-color 0.2s; }
        button:disabled { background-color: #6c757d; cursor: not-allowed; }
        .status-check { display: flex; align-items: center; gap: 0.75rem; margin-top: 1rem; }
        .status-light { width: 12px; height: 12px; border-radius: 50%; background-color: #6c757d; transition: background-color 0.3s; }
        .status-light.is-ok { background-color: #28a745; }
        .status-light.is-bad { background-color: #dc3545; }
        .status-text { font-weight: 500; }
        .status-text.is-ok { color: #28a745; }
        .status-text.is-bad { color: #dc3545; }
    </style>
</head>
<body>
    <div class="wizard">
        <!-- Stap 1: Security Rules Openen -->
        <div class="step" id="step-1">
            <h2>Stap 1: Zet de Database Open</h2>
            <p>Kopieer de onderstaande regels en plak ze in je <a href="https://console.firebase.google.com/project/voetbaltrainers/firestore/rules" target="_blank">Firebase Security Rules</a>. Druk daarna op 'Publiceren'.</p>
            <textarea readonly>rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /{document=**} {
      allow read, write: if true;
    }
  }
}</textarea>
            <div class="status-check">
                <button id="check-open-btn">Controleer Permissies</button>
                <div id="open-status-light" class="status-light"></div>
                <span id="open-status-text" class="status-text">Wacht op controle...</span>
            </div>
        </div>

        <!-- Stap 2: Data Updaten -->
        <div class="step is-disabled" id="step-2">
            <h2>Stap 2: Update Engelse Data</h2>
            <p>Klik op de knop om het veld `"land": "England"` toe te voegen aan alle seizoensdocumenten die dit veld nog niet hebben.</p>
            <div class="status-check">
                <button id="update-btn">Start Update</button>
                <span id="update-status-text" class="status-text">Klaar om te updaten.</span>
            </div>
        </div>

        <!-- Stap 3: Security Rules Sluiten -->
        <div class="step is-disabled" id="step-3">
            <h2>Stap 3: Zet de Database Dicht</h2>
            <p><strong>BELANGRIJK:</strong> Kopieer nu de onderstaande regels en plak ze terug in je Firebase Security Rules om je database te beveiligen.</p>
            <textarea readonly>rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /{document=**} {
      allow read: if true;
      allow write: if false;
    }
  }
}</textarea>
            <div class="status-check">
                <button id="check-closed-btn">Controleer Beveiliging</button>
                <div id="closed-status-light" class="status-light"></div>
                <span id="closed-status-text" class="status-text">Wacht op controle...</span>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getFirestore, collection, getDocs, writeBatch, doc, setDoc, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        
        const firebaseConfig = {
          apiKey: "AIzaSyDZckphHLQiTK2KZHPOyPDxgB6glBr4HpY",
          authDomain: "voetbaltrainers.firebaseapp.com",
          projectId: "voetbaltrainers",
          storageBucket: "voetbaltrainers.appspot.com",
          messagingSenderId: "640532231483",
          appId: "1:640532231483:web:54d614b65b3e2c4adc731e",
          measurementId: "G-YQV6E3V2CK"
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // UI Elementen
        const steps = {
            1: document.getElementById('step-1'),
            2: document.getElementById('step-2'),
            3: document.getElementById('step-3')
        };
        const buttons = {
            checkOpen: document.getElementById('check-open-btn'),
            update: document.getElementById('update-btn'),
            checkClosed: document.getElementById('check-closed-btn')
        };
        const statuses = {
            openLight: document.getElementById('open-status-light'),
            openText: document.getElementById('open-status-text'),
            updateText: document.getElementById('update-status-text'),
            closedLight: document.getElementById('closed-status-light'),
            closedText: document.getElementById('closed-status-text')
        };

        // Stap 1: Permissies controleren
        buttons.checkOpen.addEventListener('click', async () => {
            statuses.openText.textContent = 'Bezig met testen...';
            const testDocRef = doc(db, 'permissions-test', 'test-doc');
            try {
                await setDoc(testDocRef, { timestamp: new Date() });
                await deleteDoc(testDocRef);
                statuses.openLight.className = 'status-light is-ok';
                statuses.openText.className = 'status-text is-ok';
                statuses.openText.textContent = 'Permissies correct ingesteld!';
                steps[2].classList.remove('is-disabled');
            } catch (e) {
                statuses.openLight.className = 'status-light is-bad';
                statuses.openText.className = 'status-text is-bad';
                statuses.openText.textContent = 'Fout: Geen schrijfrechten. Controleer de regels.';
            }
        });

        // Stap 2: Data Updaten
        buttons.update.addEventListener('click', async () => {
            buttons.update.disabled = true;
            statuses.updateText.textContent = 'Seizoenen ophalen...';

            try {
                const seizoenenCol = collection(db, "seizoenen");
                const snapshot = await getDocs(seizoenenCol);
                
                const batch = writeBatch(db);
                let updateCount = 0;

                snapshot.docs.forEach(doc => {
                    const data = doc.data();
                    // Update alleen documenten waar het 'land' veld ontbreekt.
                    if (data.land === undefined) {
                        batch.update(doc.ref, { land: "England" });
                        updateCount++;
                    }
                });

                if (updateCount > 0) {
                    statuses.updateText.textContent = `${updateCount} documenten worden geÃ¼pdatet...`;
                    await batch.commit();
                    statuses.updateText.className = 'status-text is-ok';
                    statuses.updateText.textContent = `Update voltooid! ${updateCount} documenten zijn bijgewerkt.`;
                } else {
                    statuses.updateText.className = 'status-text is-ok';
                    statuses.updateText.textContent = 'Geen documenten om te updaten. De data is al correct.';
                }

                steps[3].classList.remove('is-disabled');

            } catch (error) {
                statuses.updateText.className = 'status-text is-bad';
                statuses.updateText.textContent = `Fout: ${error.message}`;
                buttons.update.disabled = false;
            }
        });

        // Stap 3: Beveiliging controleren
        buttons.checkClosed.addEventListener('click', async () => {
             statuses.closedText.textContent = 'Bezig met testen...';
            const testDocRef = doc(db, 'permissions-test', 'test-doc-final');
            try {
                await setDoc(testDocRef, { timestamp: new Date() });
                statuses.closedLight.className = 'status-light is-bad';
                statuses.closedText.className = 'status-text is-bad';
                statuses.closedText.textContent = 'Fout: Database staat nog open! Controleer de regels.';
                await deleteDoc(testDocRef);
            } catch (e) {
                statuses.closedLight.className = 'status-light is-ok';
                statuses.closedText.className = 'status-text is-ok';
                statuses.closedText.textContent = 'Database succesvol beveiligd!';
            }
        });

    </script>
</body>
</html>
